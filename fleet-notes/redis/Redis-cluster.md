---
title: Redis-cluster
tags:
  - fleet-note
  - middleware/redis/scalability/cluster
date: 2024-11-29
time: 14:55
aliases:
---
首先根据键值对的 key，按照CRC16 算法计算一个 16 bit 的值；然后，再用这个 16bit 值对 16384 取模，得到 0~16383 范围内的模数，每个模数代表一个相应编号的哈希槽。

需要关注两个问题：
1. 如何分配槽？（新加入机器）
2. 客户端怎么知道数据在哪里

集群的实例之间是可以同步信息的，当客户端访问实例后，就可以获取哈希槽的分配地址，以后也就可以获取数据了。
但如果进行了重新分配，那客户端是无法感知的。Redis 提供了重定向机制来解决这个问题。

比如客户端缓存的 key name 是在哈希槽 100 上，该哈希槽位于 redis-1 机器，但加入新加了机器 redis-x，100 的哈希槽分配到 redis-x 上了。
客户端访问到了 redis-1 的机器，如果该哈希槽已经迁移到 redis-x 了，则会回复：
```shell
(error) MOVED 100 redis-x:6379
```
如此客户端就可以访问 redis-x 实例去获取数据了，同时也更改本地缓存的哈希槽分配信息。

也有可能哈希槽 100 的数据是没有迁移结束的，比如哈希槽有 key 1，2，3，4，1 和 2 已经迁移到 redis-x 实例上，当客户端访问数据 key 1 时，会响应：
```c
(error) ASK 13320 redis-x:6379
```
此时客户端需要发送 ASKING 命令给 redis-x 实例，让 redis-x 实例允许执行接下来客户端发送的命令，然后客户端在获取数据。
如果直接去获取，则会报错。
# References