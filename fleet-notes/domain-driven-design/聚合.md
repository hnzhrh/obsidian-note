---
title: 聚合
tags:
  - fleet-note
  - architecture/ddd
  - product/skills/event-storming
date: 2024-11-06
time: 19:38
aliases:
  - aggregate
---
# 什么是聚合？

聚合是业务逻辑上紧密关联的[领域实体](领域实体.md) 和[值对象](值对象.md)组合而成，用来确保这些[领域实体](领域实体.md)的数据一致性，聚合是数据修改和持久化的基本单元，一个聚合对应一个仓储，聚合中的[领域实体](领域实体.md)不允许单独被访问。

聚合会有一个[[聚合根]]和上下文边界。

跨多个[领域实体](领域实体.md)的业务逻辑通过[[领域服务]]来实现，跨多个聚合的业务逻辑通过应用服务层来编排。

在业务体量快速发展阶段，日后可以将聚合拆分成单独的微服务
# 如何设计聚合？

1. 使用[事件风暴](事件风暴.md)梳理[领域事件](领域事件.md)、[领域实体](领域实体.md)、 [值对象](值对象.md)等等
2. 从[领域实体](领域实体.md)中选出[聚合根](聚合根.md)。判断一个[领域实体](领域实体.md)是否可以作为[聚合根](聚合根.md)可以通过以下方式判断：
	1. 是否有独立的生命周期？
	2. 是否有全局唯一 ID？
	3. 是否可以创建修改其他[领域实体](领域实体.md)
3. 找出与[聚合根](聚合根.md)紧密关联的[领域实体](领域实体.md)和[值对象](值对象.md)构成一个包含唯一一个[聚合根](聚合根.md)的集合，这个集合就是聚合
4. 分析[聚合根](聚合根.md)、[领域实体](领域实体.md) 、[值对象](值对象.md)的依赖关系，可以输出 UML 以支撑代码落地
5. 多个聚合根据业务划分到同一个限界上下文中

# 聚合的一些原则

1. 在一致性边界内建模真正的不变条件。聚合用来封装真正的不变性，而不是简单地将对象组合在一起。聚合内有一套不变的业务规则，各实体和值对象按照统一的业务规则运行，实现对象数据的一致性，边界之外的任何东西都与该聚合无关，这就是聚合能实现业务高内聚的原因。
2. 设计小聚合。如果聚合设计得过大，聚合会因为包含过多的实体，导致实体之间的管理过于复杂，高频操作时会出现并发冲突或者数据库锁，最终导致系统可用性变差。而小聚合设计则可以降低由于业务过大导致聚合重构的可能性，让领域模型更能适应业务的变化。
3. 通过唯一标识引用其它聚合。聚合之间是通过关联外部聚合根 ID 的方式引用，而不是直接对象引用的方式。外部聚合的对象放在聚合边界内管理，容易导致聚合的边界不清晰，也会增加聚合之间的耦合度。
4. **在边界之外使用最终一致性。聚合内数据强一致性，而聚合之间数据最终一致性。在一次事务中，最多只能更改一个聚合的状态。如果一次业务操作涉及多个聚合状态的更改，应采用领域事件的方式异步修改相关的聚合，实现聚合之间的解耦（相关内容我会在领域事件部分详解）。**
5. 通过应用层实现跨聚合的服务调用。为实现微服务内聚合之间的解耦，以及未来以聚合为单位的微服务组合和拆分，应避免跨聚合的领域服务调用和跨聚合的数据库表关联。

# References

* [05 | 聚合和聚合根：怎样设计聚合？-DDD实战课-极客时间](https://time.geekbang.org/column/article/154547)